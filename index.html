<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èµ·é‡æ©Ÿ/åŠæ›ä½œæ¥­å‰è¯åˆè‡ªæª¢è¡¨</title>
    
    <link rel="manifest" href="manifest.json">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="èµ·é‡åŠæ›æª¢æŸ¥">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <meta name="theme-color" content="#2c3e50">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* === å…¨å±€æ¨£å¼ === */
        body { 
            padding: 15px; 
            padding-bottom: 120px; 
            background-color: #e9ecef; 
            font-family: -apple-system, "Microsoft JhengHei", "Heiti TC", sans-serif; 
            color: #333; 
            overscroll-behavior-y: none;
        }
        
        #app-container { max-width: 800px; margin: 0 auto; }
        
        .card-box { 
            background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; position: relative;
        }
        .app-header { text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .app-title { font-size: 1.5rem; font-weight: 900; color: #2c3e50; }
        .section-title { font-size: 1.1rem; font-weight: bold; color: #0d6efd; margin-bottom: 15px; border-left: 4px solid #0d6efd; padding-left: 10px;}
        label { font-weight: bold; color: #555; margin-bottom: 5px; display: block; font-size: 0.95rem; }
        input[type="text"], input[type="date"], select { 
            width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 8px; 
            font-size: 16px; margin-bottom: 15px; background: #fff; 
        }
        
        /* æª¢æŸ¥é …ç›®æ¨£å¼ */
        .panel-row { 
            background: white; margin-bottom: 15px; padding: 15px; border-radius: 12px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 6px solid #ccc; 
            transition: all 0.3s;
        }
        /* é¡Œçµ„æ¨£å¼ */
        .group-box {
            background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 12px; margin-bottom: 20px;
        }
        .group-title {
            color: #0d6efd; font-weight: bold; font-size: 1.1rem; border-bottom: 2px solid #dee2e6; 
            padding-bottom: 8px; margin-bottom: 15px;
        }
        /* ä¸‹æ‹‰é¸å–®é¡Œå‹æ¨£å¼ */
        .select-box {
            border-left: 5px solid #fd7e14; background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .panel-row.completed { border-left-color: #198754; } 
        .panel-row.error { border-left-color: #dc3545; background-color: #fff8f8; }
        .item-title { font-weight: bold; font-size: 1.1rem; color: #222; margin-bottom: 10px; line-height: 1.4; }

        .illustration-container {
            text-align: center; margin-bottom: 15px; padding: 10px;
            background-color: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;
        }
        .illustration-img {
            max-width: 100%; max-height: 200px; object-fit: contain; border-radius: 4px; border: 1px solid #eee;
        }

        .btn-check-group { display: flex; gap: 5px; width: 100%; }
        .btn-check-group input { display: none; }
        .btn-check-label { 
            flex: 1; text-align: center; padding: 12px; border: 1px solid #ced4da; 
            border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; 
            background: #fff; color: #666; transition: 0.2s;
        }
        .btn-check-pass:checked + label { background: #198754; color: white; border-color: #198754; }
        .btn-check-fail:checked + label { background: #dc3545; color: white; border-color: #dc3545; }
        .preview-container { text-align: center; margin-top: 10px; }
        .preview-img { max-width: 100%; height: 200px; object-fit: contain; border-radius: 8px; border: 1px solid #ddd; display: none; margin-top: 5px; }
        
        .sig-wrapper { 
            width: 100%; height: 180px; border: 2px dashed #bbb; border-radius: 8px; 
            background: #fff; touch-action: none; position: relative;
        }
        canvas { width: 100%; height: 100%; display: block; cursor: crosshair; }
        .sig-error { border-color: #dc3545; background: #fff5f5; }
        .fab-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; align-items: flex-end; }
        .btn-float { 
            padding: 12px 20px; border-radius: 50px; color: white; font-weight: bold; border: none; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; min-width: 120px; font-size: 1rem;
        }
        .btn-main { background: linear-gradient(135deg, #0d6efd, #0b5ed7); }
        .btn-warn { background: linear-gradient(135deg, #dc3545, #b02a37); font-size: 0.9rem; min-width: 100px; }
        
        #ios-install-prompt {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 2000; text-align: center;
        }
        /* è§’è‰²æ¨™ç±¤ */
        .role-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 5px; font-weight: bold; color: white; }
        .badge-op { background-color: #0d6efd; }
        .badge-rig { background-color: #fd7e14; }
        .badge-all { background-color: #6610f2; }
    </style>
</head>
<body>

<div class="fab-container" id="fab-menu">
    <button type="button" class="btn-float btn-main" onclick="downloadReport()">ğŸ“¥ ä¸‹è¼‰å ±å‘Š</button>
    <button type="button" class="btn-float btn-warn" onclick="clearDraft()">ğŸ—‘ï¸ æ¸…é™¤é‡å¡«</button>
</div>

<div class="container" id="app-container">
    <form id="checkForm">
        <div class="card-box">
            <div class="app-header">
                <div class="app-title">ğŸ—ï¸ èµ·é‡åŠæ›ä½œæ¥­å‰è¯åˆè‡ªæª¢</div>
                <small id="autoSaveStatus" style="color:#198754; display:none; font-weight:bold;">âœ… å·²è‡ªå‹•å„²å­˜</small>
            </div>
            <div class="section-title">1. ä½œæ¥­åŸºæœ¬è³‡æ–™ (å¿…å¡«)</div>
            <div class="row">
                <div class="col-12"><label>æª¢æŸ¥æ—¥æœŸ Date</label><input type="date" id="checkDate"></div>
            </div>
            <div class="row">
                <div class="col-6"><label>1. ä¸»æ‰¿å•† Main Contractor</label><input type="text" id="mainContractor" placeholder="è¼¸å…¥ä¸»æ‰¿å•†..." oninput="autoSave()"></div>
                <div class="col-6"><label>2. æ¬¡æ‰¿å•† Sub Contractor</label><input type="text" id="subContractor" placeholder="è¼¸å…¥æ¬¡æ‰¿å•†..." oninput="autoSave()"></div>
            </div>
            <div class="row">
                <div class="col-12">
                    <label style="color:#d63384;">3. ä½œæ¥­èº«åˆ† Role (æ±ºå®šæª¢æŸ¥é …ç›®) â˜…</label>
                    <select id="userRole" onchange="renderPanels(); autoSave();" style="border: 2px solid #d63384;">
                        <option value="">-- è«‹é¸æ“‡èº«åˆ† --</option>
                        <option value="operator">èµ·é‡æ©Ÿæ“ä½œæ‰‹ (Operator)</option>
                        <option value="rigger">åŠæ›æŒ‡æ®æ‰‹ (Rigger)</option>
                        <option value="both">æ“ä½œåŠåŠæ›æ‰‹ (å…©è€…å…¼ä»»)</option>
                    </select>
                </div>
                <div class="col-6"><label>4. æª¢æŸ¥äººå“¡å§“å Name</label><input type="text" id="inspectorName" placeholder="è¼¸å…¥å§“å..." oninput="autoSave()"></div>
                <div class="col-6"><label>5. åŠæ›é»ä½/è»Šè™Ÿ</label><input type="text" id="liftingPoint" placeholder="è¼¸å…¥é»ä½..." oninput="autoSave()"></div>
            </div>
        </div>

        <div id="panelList"></div>

        <div class="card-box" id="sig-section">
            <div class="section-title">3. ç°½åç¢ºèª Signature (å¿…å¡«)</div>
            <div class="sig-wrapper" id="sig-container">
                <canvas id="sig-canvas"></canvas>
            </div>
            <div style="margin-top:10px; text-align:right;">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSignature()">â†º æ¸…é™¤é‡ç°½</button>
            </div>
        </div>
    </form>
</div>

<div id="ios-install-prompt">
    <p>ğŸ“² <strong>å®‰è£åˆ°æ‰‹æ©Ÿï¼š</strong><br>é»æ“Šä¸‹æ–¹åˆ†äº«æŒ‰éˆ•ï¼Œç„¶å¾Œé¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</p>
    <button class="btn btn-sm btn-outline-dark" onclick="document.getElementById('ios-install-prompt').style.display='none'">é—œé–‰</button>
</div>

<script>
    // === 1. æ•´åˆå¾Œçš„è³‡æ–™è¨­å®š (åŒ…å« Role å±¬æ€§) ===
    const CHECK_CONFIG = [
        // --- é€šç”¨å¿…å¡«é¡Œ (æ‰€æœ‰äººéƒ½çœ‹å¾—åˆ°) ---
        {
            type: "simple",
            id: "global_license",
            title: "ã€ä¸€æ©Ÿä¸‰è­‰ã€‘åŠæ›ä½œæ¥­é–‹å§‹å‰ï¼Œæ˜¯å¦å·²ç¢ºèªå…·å‚™ä¸€æ©Ÿä¸‰è­‰ (èµ·é‡æ©Ÿè­‰ã€æ“ä½œæ‰‹è­‰ã€åŠæ›æ‰‹è­‰)ï¼Ÿ",
            image: "",
            role: "all" // æ¨™è¨˜ç‚ºå…¨éƒ¨å¯è¦‹
        },

        // --- èµ·é‡æ©Ÿæ“ä½œæ‰‹é¡Œç›® (Code 1) ---
        {
            type: "group",
            id: "op_part1",
            title: "A. æ“ä½œæ‰‹ - å‰ç½®æº–å‚™èˆ‡è¨­å®š",
            role: "operator", // æ¨™è¨˜ç‚ºæ“ä½œæ‰‹
            items: [
                { id: "op_01", title: "ã€æŒ‡æ®ç³»çµ±ã€‘æ˜¯å¦å·²ç¢ºèªå”¯ä¸€çš„å°ˆè²¬æŒ‡æ®æ‰‹æ˜¯èª°ï¼Œä¸”é›™æ–¹æºé€šçš„æ‰‹å‹¢æˆ–ç„¡ç·šé›»ä¿¡è™Ÿæ˜¯å¦å·²ç´„å®šçµ±ä¸€ï¼Ÿ", image: "" },
                { id: "op_02", title: "ã€æ–‡æ›¸è¨±å¯ã€‘æ˜¯å¦å·²ç¢ºèªæ–½å·¥å–®/æ´¾å·¥å–®å…§å®¹ç„¡èª¤ï¼Œä¸”æ‚¨æ˜¯å¦å·²å……åˆ†äº†è§£ä»Šæ—¥ä½œæ¥­çš„æ½›åœ¨å±å®³èˆ‡é¢¨éšªï¼Ÿ", image: "" },
                { id: "op_03", title: "ã€æ¯æ—¥è‡ªæª¢ã€‘æ˜¯å¦å·²ç¢ºå¯¦å¡«å¯«æ¯æ—¥è‡ªæª¢è¡¨ï¼Œä¸¦ç¢ºèªéæ²é é˜²è£ç½®ã€éè² è·é™åˆ¶å™¨ã€åˆ¶å‹•å™¨åŠé˜²è„«ç‰‡åŠŸèƒ½æ­£å¸¸ï¼Ÿ", image: "" },
                { id: "op_04", title: "ã€è·é‡ç¢ºèªã€‘æ˜¯å¦å·²æŸ¥é–±èµ·é‡æ©Ÿè·é‡è¡¨ï¼Œä¸¦ç¢ºèªæœ¬æ¬¡åŠæ›ç‰©é‡é‡ç¢ºå¯¦å°æ–¼ç•¶ä¸‹å·¥æ³çš„é¡å®šè·é‡ï¼Ÿ", image: "" },
                { id: "op_05", title: "ã€å€åŸŸç®¡åˆ¶ã€‘æ˜¯å¦å·²ç¢ºèªä½œæ¥­åŠå¾‘åŠè¿´è½‰ç¯„åœå…§å®Œæˆç®¡åˆ¶ï¼Œä¸”åŠèˆ‰è·¯å¾‘ä¸‹æ–¹å·²ä¿æŒæ·¨ç©ºï¼Ÿ", image: "" },
                { id: "op_06", title: "ã€æ©Ÿèº«ç©©å®šã€‘å¤–ä¼¸æ’åº§æ˜¯å¦å·²ä¾è¦å®šå®Œå…¨ä¼¸å‡ºï¼Œä¸”æ”¯æ’åœ°é¢å …å›ºä¸¦å·²ç¢ºå¯¦é‹ªå¢Šæ•æœ¨æˆ–éµæ¿ï¼Ÿ", image: "" }
            ]
        },
        {
            type: "group",
            id: "op_part2",
            title: "B. æ“ä½œæ‰‹ - æ¸¬è©¦èˆ‡é‹è¡Œæ§åˆ¶",
            role: "operator",
            items: [
                { id: "op_07", title: "ã€æ¥µé™æ¸¬è©¦ã€‘(é˜²æ­¢æ’å¤©èŠ±æ¿) åœ¨æ›ä¸Šé‡ç‰©å‰ï¼Œæ˜¯å¦å·²å…ˆé€²è¡Œç©ºè¼‰æ¸¬è©¦ï¼Œç¢ºèªä¸Šæ²é é˜²è£ç½®(æ¥µé™é–‹é—œ)æœ‰æ•ˆï¼Ÿ", image: "" },
                { id: "op_08", title: "ã€è©¦åŠç¢ºèªã€‘(é˜²æ­¢ç…è»Šå¤±æ•ˆ) èµ·åŠé›¢åœ° 10~20 å…¬åˆ†æ™‚ï¼Œæ˜¯å¦åŸ·è¡Œã€Œæš«åœå‹•ä½œã€ï¼Œç¢ºèªåˆ¶å‹•å™¨ç„¡ä¸‹æ»‘ç¾è±¡ï¼Ÿ", image: "" },
                { id: "op_09", title: "ã€é˜²æ“ºæ§åˆ¶ã€‘(é˜²æ­¢æ’æ“Š) æ“ä½œæ™‚æ˜¯å¦ç¢ºèªåŠé‰¤ä½æ–¼è² è¼‰é‡å¿ƒæ­£ä¸Šæ–¹(ç„¡æ­ªæ‹‰æ–œåŠ)ï¼Œç¢ºä¿èµ·åŠå¹³ç©©ï¼Ÿ", image: "" },
                { id: "op_13", title: "ã€ç·Šæ€¥æ‡‰è®Šã€‘æ˜¯å¦æ¸…æ¥šç·Šæ€¥åœæ­¢æŒ‰éˆ•(E-Stop)ä½ç½®ï¼Œä¸”ç¢ºèªåŠŸèƒ½æ­£å¸¸ï¼Ÿ", image: "" }
            ]
        },

        // --- åŠæ›æŒ‡æ®æ‰‹é¡Œç›® (Code 2) ---
        {
            type: "selection", // ä¸‹æ‹‰é¸å–®é¡Œå‹
            id: "rig_part1",
            title: "C. åŠæ›æ‰‹ - åŠæ›ç´¢å…·æª¢é» (è«‹é¸æ“‡)",
            role: "rigger", // æ¨™è¨˜ç‚ºåŠæ›æ‰‹
            options: {
                "none": { label: "-- è«‹é¸æ“‡ç´¢å…·é¡å‹ --", items: [] },
                "wire": { 
                    label: "ã€é‹¼ç´¢ã€‘", 
                    items: [
                        { id: "w1", title: "ã€é‹¼ç´¢æª¢æŸ¥ã€‘é‹¼ç´¢æ–·çµ²æ˜¯å¦ç„¡é”åˆ°10%ç´ ç·šæˆªæ–·?", image: "1-1.png" },
                        { id: "w2", title: "ã€é‹¼ç´¢æª¢æŸ¥ã€‘é‹¼ç´¢ç£¨æèˆ‡è®Šå½¢æ˜¯å¦ç„¡é”åˆ°ç›´å¾‘æ¸›å°‘7%?", image: "1-2.png" }
                    ]
                },
                "chain": { 
                    label: "ã€åŠéˆã€‘", 
                    items: [
                        { id: "c1", title: "ã€åŠéˆæª¢æŸ¥ã€‘åŠéˆæ˜¯å¦ç„¡å»¶ä¼¸é•·åº¦é”5%æˆ–æ–·é¢ç›´å¾‘æ¸›å°‘10%?", image: "2-1.png" },
                        { id: "c2", title: "ã€åŠéˆæª¢æŸ¥ã€‘åŠéˆæ˜¯å¦ç„¡é¾œè£‚?", image: "2-2.png" }
                    ]
                },
                "fiber": { 
                    label: "ã€çº–ç¶­åŠå¸¶/ç¹©ã€‘", 
                    items: [
                        { id: "f1", title: "ã€çº–ç¶­åŠå¸¶æª¢æŸ¥ã€‘çº–ç¶­åŠå¸¶/ç¹©æ˜¯å¦ç„¡åˆ‡ç—•æˆ–ç ´æ?", image: "3-1.png" },
                        { id: "f2", title: "ã€çº–ç¶­åŠå¸¶æª¢æŸ¥ã€‘å¤–è§€æ¨™ç¤ºæ˜¯å¦æ¸…æ¥šè¾¨è­˜?" }
                    ]
                }
            }
        },
        {
            type: "group",
            id: "rig_part2",
            title: "D. åŠæ›æ‰‹ - åŠé‰¤èˆ‡ä½œæ¥­å‰ç¢ºèª",
            role: "rigger",
            items: [
                { id: "h1", title: "ã€åŠé‰¤ã€‘åŠæ›é‰¤é ­æ’éŠ·æ˜¯å¦å®Œå…¨æ’å…¥ï¼Œä¸”ç„¡è®Šå½¢é–‹å£ï¼Ÿ", image: "2.2.png" },
                { id: "p1", title: "ã€æŒ‡æ®è³‡æ ¼ã€‘ç¾å ´æ˜¯å¦å·²æŒ‡æ´¾å°ˆè²¬æŒ‡æ®äººå“¡ï¼Œä¸”å…·å‚™åˆæ ¼è­‰ç…§ï¼Ÿ", image: "" },
                { id: "p4", title: "ã€è·é‡ç¢ºèªã€‘æ˜¯å¦å·²ç¢ºèªåŠæ›ç‰©é‡é‡åœ¨é¡å®šè·é‡ç¯„åœå…§ï¼Œä¸”åŠå…·å¼·åº¦è¶³å¤ ï¼Ÿ", image: "" },
                { id: "p5", title: "ã€å€åŸŸç®¡åˆ¶ã€‘åŠæ›ä½œæ¥­å€åŸŸæ˜¯å¦å·²åœè¨­è­¦ç¤ºå¸¶ï¼Œä¸”è·¯å¾‘ä¸‹æ–¹æ·¨ç©ºï¼Ÿ", image: "" },
                { id: "op_10", title: "ã€éŠ³è§’é˜²è­·ã€‘åŠæ›ç‰©è‹¥æœ‰éŠ³åˆ©é‚Šç·£ï¼Œæ˜¯å¦å·²ä½¿ç”¨è­·è§’æˆ–é˜²åˆ‡å‰²å¥—ï¼Ÿ", image: "" },
                { id: "op_12", title: "ã€é˜²æ»‘ç¢ºèªã€‘è‹¥åŠæ›æ•£ç‹€ç‰©ï¼Œæ˜¯å¦å·²æ¡ç”¨ã€Œé›™åœˆæŸé ¸ã€ç¶æ³•ä¸¦ç¢ºèªç‰¢å›ºï¼Ÿ", image: "" }
            ]
        },
        {
            type: "simple",
            id: "rig_333",
            title: "E. åŠæ›ä½œæ¥­å‰æ˜¯å¦å®Œæˆè©¦åŠ333é‹å‹•ï¼Ÿ",
            role: "rigger",
            image: "3.png"
        }
    ];

    // === 2. Service Worker èˆ‡ iOS ===
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW failed', err)); });
    }
    const isIos = () => /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
    const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);
    if (isIos() && !isInStandaloneMode()) setTimeout(() => document.getElementById('ios-install-prompt').style.display = 'block', 2000);

    // === 3. IndexedDB è³‡æ–™åº« ===
    const DB_NAME = "UnifiedCheckDB_V1"; 
    const STORAGE_KEY = "UNIFIED_DRAFT";
    let db;
    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = (e) => { db = e.target.result; if(!db.objectStoreNames.contains("drafts")) db.createObjectStore("drafts", { keyPath: "id" }); };
    request.onsuccess = (e) => { db = e.target.result; initPage(); };

    // === 4. ç°½åæ¿ ===
    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    function resizeCanvas() {
        const wrapper = canvas.parentElement; const rect = wrapper.getBoundingClientRect(); const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = rect.width * ratio; canvas.height = rect.height * ratio;
        ctx.scale(ratio, ratio); ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = '#000';
    }
    window.addEventListener('resize', resizeCanvas);
    function getPos(e) { const rect = canvas.getBoundingClientRect(); const cx = e.touches ? e.touches[0].clientX : e.clientX; const cy = e.touches ? e.touches[0].clientY : e.clientY; return { x: cx - rect.left, y: cy - rect.top }; }
    function startDraw(e) { if(e.target===canvas)e.preventDefault(); isDrawing=true; const pos=getPos(e); ctx.beginPath(); ctx.moveTo(pos.x,pos.y); }
    function draw(e) { if(!isDrawing)return; if(e.target===canvas)e.preventDefault(); const pos=getPos(e); ctx.lineTo(pos.x,pos.y); ctx.stroke(); }
    function stopDraw() { if(isDrawing){ isDrawing=false; autoSave(); } }
    canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stopDraw); canvas.addEventListener('mouseout', stopDraw);
    canvas.addEventListener('touchstart', startDraw, {passive:false}); canvas.addEventListener('touchmove', draw, {passive:false}); canvas.addEventListener('touchend', stopDraw);
    function clearSignature() { ctx.clearRect(0,0,canvas.width,canvas.height); autoSave(); }
    function isCanvasBlank() { const blank=document.createElement('canvas'); blank.width=canvas.width; blank.height=canvas.height; return canvas.toDataURL()===blank.toDataURL(); }

    // === 5. é é¢åˆå§‹åŒ–èˆ‡æ¸²æŸ“ (æ ¸å¿ƒé‚è¼¯ä¿®æ”¹) ===
    function initPage() {
        const now = new Date();
        document.getElementById('checkDate').value = now.toISOString().split('T')[0];
        // åˆå§‹æš«æ™‚ä¸æ¸²æŸ“ï¼Œç­‰ Load DB å¾Œæ ¹æ“š Role æ¸²æŸ“ï¼Œè‹¥ç„¡ Role å‰‡æ¸…ç©º
        loadDraftFromDB();
        setTimeout(resizeCanvas, 100);
    }

    // æ ¸å¿ƒæ¸²æŸ“å‡½æ•¸ï¼šæ ¹æ“šä¸‹æ‹‰é¸å–®æ±ºå®šé¡¯ç¤ºå“ªäº›é¡Œç›®
    function renderPanels() {
        const container = document.getElementById('panelList'); 
        const userRole = document.getElementById('userRole').value;
        
        // å¦‚æœæœªé¸æ“‡èº«åˆ†ï¼Œé¡¯ç¤ºæç¤º
        if(!userRole) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">è«‹å…ˆæ–¼ä¸Šæ–¹ã€Œä½œæ¥­èº«åˆ†ã€é¸æ“‡æ‚¨çš„è§’è‰²<br>ä»¥è¼‰å…¥å°æ‡‰æª¢æŸ¥è¡¨ã€‚</div>`;
            return;
        }

        container.innerHTML = `<div class="section-title">2. æª¢æŸ¥é …ç›® Checklist</div>`;
        
        // éæ¿¾é‚è¼¯
        const filteredConfig = CHECK_CONFIG.filter(config => {
            if (config.role === 'all') return true; // ä¸€æ©Ÿä¸‰è­‰æ°¸é é¡¯ç¤º
            if (userRole === 'both') return true; // å…©è€…å…¼ä»»é¡¯ç¤ºå…¨éƒ¨
            return config.role === userRole; // å¦å‰‡åªé¡¯ç¤ºå°æ‡‰è§’è‰²
        });
        
        filteredConfig.forEach((config) => {
            let html = "";
            let roleBadge = "";
            
            // æ¨™ç±¤é¡¯ç¤º UI å„ªåŒ–
            if(config.role === 'all') roleBadge = `<span class="role-badge badge-all">å…¨é«”é€šç”¨</span>`;
            else if(config.role === 'operator') roleBadge = `<span class="role-badge badge-op">æ“ä½œæ‰‹</span>`;
            else if(config.role === 'rigger') roleBadge = `<span class="role-badge badge-rig">åŠæ›æ‰‹</span>`;

            // A. ä¸‹æ‹‰é¸å–®é¡Œå‹ (ç´¢å…·)
            if(config.type === "selection") {
                let optionsHtml = Object.keys(config.options).map(key => 
                    `<option value="${key}">${config.options[key].label}</option>`
                ).join('');
                
                html += `
                <div class="select-box">
                    ${roleBadge}
                    <label style="font-size:1.1rem; color:#000;">${config.title}</label>
                    <select id="${config.id}_select" onchange="handleSelectChange('${config.id}')" style="margin-bottom:15px; border:2px solid #0d6efd;">
                        ${optionsHtml}
                    </select>
                    ${Object.keys(config.options).map(key => {
                        return `<div id="${config.id}_group_${key}" class="sub-group-container" style="display:none;">
                            ${config.options[key].items.map(item => createQuestionHtml(item)).join('')}
                        </div>`;
                    }).join('')}
                </div>`;
            } 
            // B. é¡Œçµ„é¡å‹
            else if (config.type === "group") {
                html += `
                <div class="group-box">
                    ${roleBadge}
                    <div class="group-title">${config.title}</div>
                    ${config.items.map(item => createQuestionHtml(item)).join('')}
                </div>`;
            }
            // C. ä¸€èˆ¬å–®é¡Œ
            else {
                html += `<div>${roleBadge} ${createQuestionHtml({id: config.id, title: config.title, image: config.image})}</div>`;
            }
            container.innerHTML += html;
        });
        
        // é‡æ–°ç¶å®šäº‹ä»¶å¾Œï¼Œè‹¥æœ‰å·²å­˜è³‡æ–™éœ€æ¢å¾©å‹¾é¸ç‹€æ…‹ (å› ç‚º DOM é‡å»ºäº†)
        // ä½†ç”±æ–¼ autoSave æœƒå­˜ï¼Œæˆ‘å€‘ä¾è³´ loadDraft å†æ¬¡å¡«å……ç‹€æ…‹ï¼Œæˆ–è€…é€™è£¡åƒ…æ¸²æŸ“çµæ§‹
        // ç‚ºäº†æµæš¢é«”é©—ï¼Œæˆ‘å€‘éœ€è¦å¾ DB æˆ–è¨˜æ†¶é«”ä¸­æ¢å¾©ç‹€æ…‹ã€‚
        // é€™è£¡ç°¡å–®è™•ç†ï¼šå¦‚æœæ˜¯å› ç‚º onchange è§¸ç™¼ï¼Œä¸éœ€è¦é‡è¼‰å€¼(å› ç‚ºæ˜¯æ–°è¡¨æ ¼)ï¼Œä½†å¦‚æœæ˜¯ Load è§¸ç™¼ï¼Œæœƒåœ¨ Load å‡½æ•¸è™•ç†ã€‚
        // è‹¥ä½¿ç”¨è€…åœ¨å¡«å¯«é€”ä¸­åˆ‡æ›è§’è‰²ï¼Œæœƒè§¸ç™¼é‡æ–°æ¸²æŸ“ï¼Œå·²å¡«å¯«çš„é€šç”¨æ¬„ä½å€¼é‚„åœ¨ DOM (è‹¥ ID ç›¸åŒ)ï¼Œä½†å› ç‚º innerHTML é‡å¯«æœƒæ¶ˆå¤±ã€‚
        // å› æ­¤å»ºè­°åˆ‡æ›è§’è‰²è¦–ç‚ºé‡ç½®è¡¨æ ¼ï¼Œæˆ–è€…åœ¨ render å¾Œè£œå¡«ã€‚
        restoreValuesAfterRender();
    }

    function createQuestionHtml(item) {
        let illustrationHtml = "";
        if(item.image) {
            illustrationHtml = `
            <div class="illustration-container">
                <span class="badge bg-secondary mb-1">åƒè€ƒç¤ºæ„åœ–</span><br>
                <img src="${item.image}" class="illustration-img" onerror="this.style.display='none'" alt="ç¤ºæ„åœ–">
            </div>`;
        }
        return `
        <div class="panel-row" id="row_${item.id}" data-id="${item.id}">
            <div class="item-title">${item.title}</div>
            ${illustrationHtml}
            <div class="btn-check-group">
                <input type="radio" class="btn-check-pass" name="${item.id}" id="${item.id}_pass" value="Pass" onchange="checkStatus('${item.id}'); autoSave()">
                <label class="btn-check-label" for="${item.id}_pass">æ˜¯ (æ­£å¸¸)</label>
                <input type="radio" class="btn-check-fail" name="${item.id}" id="${item.id}_fail" value="Fail" onchange="checkStatus('${item.id}'); autoSave()">
                <label class="btn-check-label" for="${item.id}_fail">å¦ (ç•°å¸¸)</label>
            </div>
            <div style="margin-top:10px;">
                <input type="text" id="note_${item.id}" placeholder="å‚™è¨»èªªæ˜..." oninput="autoSave()" style="margin-bottom:5px;">
                <label class="btn btn-sm btn-outline-secondary w-100">
                    ğŸ“· æ‹æ”ç…§ç‰‡ / ä¸Šå‚³
                    <input type="file" id="file_${item.id}" accept="image/*" capture="environment" style="display:none" onchange="handleImage(this, '${item.id}')">
                </label>
                <div class="preview-container"><img id="preview_${item.id}" class="preview-img"></div>
            </div>
        </div>`;
    }

    window.handleSelectChange = function(groupId) {
        const select = document.getElementById(`${groupId}_select`);
        const selectedValue = select.value;
        document.querySelectorAll(`[id^="${groupId}_group_"]`).forEach(el => el.style.display = 'none');
        const target = document.getElementById(`${groupId}_group_${selectedValue}`);
        if(target) target.style.display = 'block';
        autoSave();
    }

    window.checkStatus = function(id) {
        const row = document.getElementById(`row_${id}`);
        const pass = document.getElementById(`${id}_pass`).checked;
        const fail = document.getElementById(`${id}_fail`).checked;
        row.classList.remove('completed', 'error');
        if(pass) row.classList.add('completed');
        if(fail) row.classList.add('error');
    }

    window.handleImage = function(input, id) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById(`preview_${id}`);
                img.src = e.target.result; img.style.display = 'inline-block';
                autoSave();
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // === 6. è‡ªå‹•å„²å­˜èˆ‡è®€å– ===
    let savedDataCache = null; // ç”¨æ–¼æš«å­˜è³‡æ–™ä»¥ä¾¿åˆ‡æ›è§’è‰²å¾Œå›å¡«
    let saveTimer; 
    window.autoSave = function() { clearTimeout(saveTimer); saveTimer = setTimeout(saveToDB, 500); }
    
    function saveToDB() {
        if(!db) return;
        const basicInfo = {
            date: document.getElementById('checkDate').value,
            main: document.getElementById('mainContractor').value,
            sub: document.getElementById('subContractor').value,
            role: document.getElementById('userRole').value, // å„²å­˜è§’è‰²
            insp: document.getElementById('inspectorName').value,
            point: document.getElementById('liftingPoint').value,
            selections: {}
        };
        // å„²å­˜ä¸‹æ‹‰é¸å–®ç‹€æ…‹
        CHECK_CONFIG.filter(c => c.type === 'selection').forEach(c => {
            const el = document.getElementById(`${c.id}_select`);
            if(el) basicInfo.selections[c.id] = el.value;
        });

        // æ”¶é›†æ‰€æœ‰å¯èƒ½çš„è¼¸å…¥ (å³ä½¿ç¾åœ¨ä¸å¯è¦‹ï¼Œå¦‚æœåˆ‡æ›å›ä¾†ä¹Ÿè¦ç›¡é‡ä¿ç•™ï¼Œä½†ç°¡åŒ–èµ·è¦‹åªå­˜ç›®å‰ DOM)
        // ç‚ºäº†æ”¯æ´åˆ‡æ›è§’è‰²ä¸ä¸Ÿå¤±è³‡æ–™ï¼Œé€™è£¡æ‡‰è©²å­˜è¨˜æ†¶é«”è®Šæ•¸ï¼Œä½†å¯¦å‹™ä¸Šé‡åˆ· DOM æœƒä¸Ÿå¤± listenerã€‚
        // æˆ‘å€‘é€™è£¡åªå­˜ç›®å‰ DOM æœ‰çš„æ±è¥¿ã€‚
        const radios = Array.from(document.querySelectorAll('input[type="radio"]:checked')).map(r => r.id);
        const notes = Array.from(document.querySelectorAll('input[type="text"][id^="note_"]')).reduce((acc, el) => ({...acc, [el.id]: el.value}), {});
        const images = Array.from(document.querySelectorAll('.preview-img')).reduce((acc, img) => (img.src && img.src.startsWith('data:') ? {...acc, [img.id]: img.src} : acc), {});
        
        // æ›´æ–° Cache
        savedDataCache = { radios, notes, images };

        const data = { id: STORAGE_KEY, basicInfo: basicInfo, radios: radios, notes: notes, images: images, signature: isCanvasBlank() ? null : canvas.toDataURL() };
        const tx = db.transaction(["drafts"], "readwrite"); tx.objectStore("drafts").put(data);
        tx.oncomplete = () => { const status = document.getElementById('autoSaveStatus'); status.style.display='inline'; setTimeout(()=> status.style.display='none', 2000); };
    }

    function loadDraftFromDB() {
        if(!db) return;
        db.transaction(["drafts"]).objectStore("drafts").get(STORAGE_KEY).onsuccess = (e) => {
            const data = e.target.result; if(!data) return;
            
            // 1. æ¢å¾©åŸºæœ¬è³‡æ–™èˆ‡è§’è‰²
            if(data.basicInfo) {
                document.getElementById('checkDate').value = data.basicInfo.date || "";
                document.getElementById('mainContractor').value = data.basicInfo.main || "";
                document.getElementById('subContractor').value = data.basicInfo.sub || "";
                document.getElementById('inspectorName').value = data.basicInfo.insp || "";
                document.getElementById('liftingPoint').value = data.basicInfo.point || "";
                document.getElementById('userRole').value = data.basicInfo.role || "";
            }

            // 2. è¨­ç½® Cache ä¸¦æ¸²æŸ“ç•«é¢ (é€™æœƒæ¸…ç©º DOM)
            savedDataCache = { radios: data.radios || [], notes: data.notes || {}, images: data.images || {} };
            renderPanels(); 

            // 3. æ¢å¾©é¸å–®é¸æ“‡ (éœ€åœ¨ render ä¹‹å¾Œ)
            if(data.basicInfo && data.basicInfo.selections) {
                Object.keys(data.basicInfo.selections).forEach(key => {
                    const select = document.getElementById(`${key}_select`);
                    if(select) { select.value = data.basicInfo.selections[key]; handleSelectChange(key); }
                });
            }

            // 4. æ¢å¾©å…§å®¹ (ç”± restoreValuesAfterRender çµ±ä¸€è™•ç†)
            restoreValuesAfterRender();

            if(data.signature) { const i = new Image(); i.src = data.signature; i.onload = () => ctx.drawImage(i,0,0, canvas.width, canvas.height); }
        };
    }

    function restoreValuesAfterRender() {
        if(!savedDataCache) return;
        // æ¢å¾© Radio
        if(savedDataCache.radios) {
            savedDataCache.radios.forEach(id => { 
                const el = document.getElementById(id); 
                if(el) { el.checked = true; const rowId = id.replace(/_(pass|fail)$/, ''); checkStatus(rowId); } 
            });
        }
        // æ¢å¾© Note
        if(savedDataCache.notes) {
            Object.keys(savedDataCache.notes).forEach(k => { 
                const el = document.getElementById(k); 
                if(el) el.value = savedDataCache.notes[k]; 
            });
        }
        // æ¢å¾©åœ–ç‰‡
        if(savedDataCache.images) {
            Object.keys(savedDataCache.images).forEach(k => { 
                const img = document.getElementById(k); 
                if(img) { img.src = savedDataCache.images[k]; img.style.display = 'inline-block'; } 
            });
        }
    }

    window.clearDraft = function() { if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™é‡å¡«å—ï¼Ÿ")) { db.transaction(["drafts"], "readwrite").objectStore("drafts").delete(STORAGE_KEY); location.reload(); } }

    // === 7. ä¸‹è¼‰å ±å‘Š ===
    window.downloadReport = function() {
        const basicFields = ['mainContractor', 'userRole', 'inspectorName', 'liftingPoint', 'checkDate'];
        if(basicFields.some(id => !document.getElementById(id).value)) { alert("âš ï¸ è«‹å¡«å¯«å®Œæ•´çš„ã€Œä½œæ¥­åŸºæœ¬è³‡æ–™ã€ï¼"); window.scrollTo(0,0); return; }
        if(isCanvasBlank()) { alert("âš ï¸ è«‹ç°½åï¼"); document.getElementById('sig-canvas').classList.add('sig-error'); document.getElementById('sig-section').scrollIntoView(); return; }
        
        // åƒ…é¸å–ç›®å‰å¯è¦‹çš„é¡Œç›®
        const visibleRows = Array.from(document.querySelectorAll('.panel-row')).filter(row => row.offsetParent !== null);
        
        let errorCount = 0; let firstErrorRow = null;
        visibleRows.forEach(row => {
            const id = row.getAttribute('data-id');
            const pass = document.getElementById(`${id}_pass`).checked;
            const fail = document.getElementById(`${id}_fail`).checked;
            if(!pass && !fail) { errorCount++; row.classList.add('error'); if(!firstErrorRow) firstErrorRow = row; }
        });
        if(errorCount > 0) { alert(`âŒ å°šæœ‰ ${errorCount} å€‹æª¢æŸ¥é …ç›®æœªå‹¾é¸ï¼`); firstErrorRow.scrollIntoView({behavior:'smooth', block:'center'}); return; }

        let reportItemsHtml = ""; let failCount = 0;
        visibleRows.forEach(row => {
            const id = row.getAttribute('data-id');
            const title = row.querySelector('.item-title').innerText;
            const isPass = document.getElementById(`${id}_pass`).checked;
            const noteVal = document.getElementById(`note_${id}`).value;
            const imgEl = document.getElementById(`preview_${id}`);
            if(!isPass) failCount++;
            
            const statusHtml = isPass ? '<span class="txt-pass">âœ” åˆæ ¼</span>' : '<span class="txt-fail">âœ˜ ç•°å¸¸</span>';
            const noteHtml = noteVal ? `<div style="margin-top:2px; font-size:14px; color:#555;">å‚™è¨»ï¼š${noteVal}</div>` : "";
            const imgHtml = (imgEl && imgEl.src && imgEl.style.display !== 'none') ? `<img src="${imgEl.src}" class="report-img-large">` : "";

            reportItemsHtml += `
            <div class="report-item" style="${!isPass ? 'background-color:#fff5f5;' : ''}">
                <div class="report-item-head"><span>${title}</span> ${statusHtml}</div>
                ${noteHtml} ${imgHtml}
            </div>`;
        });

        const main = document.getElementById('mainContractor').value;
        const sub = document.getElementById('subContractor').value;
        const insp = document.getElementById('inspectorName').value;
        const role = document.getElementById('userRole').options[document.getElementById('userRole').selectedIndex].text;
        const point = document.getElementById('liftingPoint').value;
        const checkDate = document.getElementById('checkDate').value;
        
        const fullHtml = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><title>èµ·é‡åŠæ›æª¢æŸ¥å ±å‘Š</title>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; padding: 40px; background: #fff; color: #000; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; border: 1px solid #ddd; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .report-header { text-align: center; border-bottom: 2px solid #0d6efd; margin-bottom: 20px; padding-bottom: 10px; }
        .report-title { font-size: 28px; font-weight: 900; margin: 0; color: #000; }
        .report-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; border: 1px solid #ddd; padding: 20px; border-radius: 5px; background: #f9f9f9; font-size: 16px; }
        .report-section-title { font-size: 18px; font-weight: bold; color: #0d6efd; border-left: 5px solid #0d6efd; padding-left: 10px; margin-bottom: 15px; margin-top: 25px; }
        .report-item { border-bottom: 1px solid #eee; padding: 12px 0; }
        .report-item-head { font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .report-img-large { max-height: 300px; max-width: 100%; border: 1px solid #ccc; display: block; margin: 8px 0; border-radius: 4px; }
        .report-footer { margin-top: 40px; display: flex; justify-content: space-between; }
        .report-sig-box { text-align: center; width: 45%; }
        .report-sig-line { border-top: 1px solid #000; padding-top: 8px; font-weight: bold; margin-top: 5px; font-size: 16px;}
        .report-sig-img { height: 70px; display: block; margin: 0 auto; }
        .txt-pass { color: #198754; } .txt-fail { color: #dc3545; }
    </style></head><body>
    <div class="container">
        <div class="report-header"><div class="report-title">ğŸ—ï¸ èµ·é‡åŠæ›ä½œæ¥­å‰è¯åˆè‡ªæª¢å ±å‘Š</div></div>
        <div class="report-info-grid">
            <div><strong>æ—¥æœŸï¼š</strong> ${checkDate}</div>
            <div><strong>ä½œæ¥­èº«åˆ†ï¼š</strong> ${role}</div>
            <div><strong>ä¸»æ‰¿å•†ï¼š</strong> ${main}</div>
            <div><strong>æ¬¡æ‰¿å•†ï¼š</strong> ${sub}</div>
            <div><strong>åŠæ›é»ä½ï¼š</strong> ${point}</div>
            <div><strong>æª¢æŸ¥äººå“¡ï¼š</strong> ${insp}</div>
        </div>
        <div class="report-section-title">æª¢æŸ¥çµæœç´°é … (${role})</div>
        <div>${reportItemsHtml}</div>
        <div style="margin-top:20px; font-size:18px; font-weight:bold; border-top:2px solid #ccc; padding-top:10px;">
            ç¸½çµï¼š${failCount > 0 ? '<span style="color:red">ç•°å¸¸ (' + failCount + ' é …) - è«‹ç«‹å³æ”¹å–„</span>' : '<span style="color:green">å…¨æ•¸åˆæ ¼ - å¯é–‹å§‹ä½œæ¥­</span>'}
        </div>
        <div class="report-footer">
            <div class="report-sig-box"><img src="${canvas.toDataURL()}" class="report-sig-img"><div class="report-sig-line">æª¢æŸ¥äººå“¡ç°½ç« </div></div>
            <div class="report-sig-box"><div style="height:70px;"></div><div class="report-sig-line">å·¥åœ°ä¸»ä»»/ç›£å·¥è¤‡æ ¸</div></div>
        </div>
    </div></body></html>`;

        const blob = new Blob([fullHtml], {type: "text/html;charset=utf-8"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `èµ·é‡åŠæ›æª¢æŸ¥_${checkDate}_${insp}.html`;
        link.click();
    }
</script>
</body>
</html>
