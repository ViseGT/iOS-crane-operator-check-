<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èµ·é‡æ©Ÿ/åŠæ›ä½œæ¥­è¯åˆè‡ªæª¢è¡¨</title>
    
    <link rel="manifest" href="manifest.json">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="èµ·é‡åŠæ›æª¢æŸ¥">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <meta name="theme-color" content="#ffffff">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* === æ­£å¼æ–‡ä»¶é¢¨æ ¼ CSS === */
        
        /* 1. èƒŒæ™¯èˆ‡é‚Šè· */
        body { 
            background-color: #555; 
            padding: 20px 10px; 
            padding-bottom: 120px; 
            font-family: "Microsoft JhengHei", "Heiti TC", serif; 
            color: #000;
        }
        
        /* 2. ä¸»å®¹å™¨ */
        #app-container { 
            max-width: 850px; 
            margin: 0 auto; 
            background-color: #fff;
            padding: 25px;
            border: 3px solid #cc0000; 
            outline: 4px solid #000000; 
            outline-offset: 3px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); 
        }
        
        /* 3. æ¨™é¡Œå€å¡Š */
        .app-header { 
            text-align: center; 
            margin-bottom: 25px; 
            padding-bottom: 15px; 
            border-bottom: 3px double #000; 
        }
        .app-title { 
            font-size: 1.8rem; 
            font-weight: 900; 
            color: #000; 
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        .doc-subtitle {
            font-size: 0.9rem;
            color: #666;
            font-weight: normal;
        }

        /* 4. å€å¡Šæ¨™é¡Œ */
        .section-title { 
            font-size: 1.2rem; 
            font-weight: bold; 
            color: #fff; 
            background-color: #000; 
            padding: 5px 10px;
            margin-bottom: 15px; 
            margin-top: 20px;
            border-left: 5px solid #cc0000; 
        }

        /* 5. è¼¸å…¥æ¬„ä½ */
        label { 
            font-weight: bold; 
            color: #000; 
            margin-bottom: 3px; 
            display: block; 
            font-size: 0.95rem; 
        }
        input[type="text"], input[type="date"], select { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #000; 
            border-radius: 0; 
            font-size: 16px; 
            margin-bottom: 15px; 
            background: #fff; 
        }
        input[type="text"]:focus, input[type="date"]:focus, select:focus {
            outline: 2px solid #cc0000;
            border-color: #cc0000;
        }
        .highlight-label { color: #cc0000 !important; font-weight: 900; }
        .highlight-input { border: 2px solid #cc0000 !important; background-color: #fffafa !important; }

        /* 6. æª¢æŸ¥é …ç›®åˆ—è¡¨ */
        .panel-row { 
            background: white; 
            margin-bottom: 0; 
            padding: 15px; 
            border-bottom: 1px dashed #999; 
            border-radius: 0;
            transition: background 0.2s;
        }
        .panel-row:last-child { border-bottom: none; }
        
        .group-box {
            background: #fff; 
            border: 2px solid #000; 
            padding: 0; 
            border-radius: 0; 
            margin-bottom: 25px;
        }

        .panel-row.completed { background-color: #f0fff4; border-left: 5px solid #198754; } 
        .panel-row.error { background-color: #fff5f5; border-left: 5px solid #dc3545; }
        .item-title { font-weight: bold; font-size: 1.05rem; color: #000; margin-bottom: 10px; line-height: 1.4; }

        /* 7. æŒ‰éˆ•æ¨£å¼ */
        .btn-check-group { display: flex; gap: 0; width: 100%; border: 1px solid #000; }
        .btn-check-label { 
            flex: 1; text-align: center; padding: 10px; 
            border: none; border-right: 1px solid #000;
            border-radius: 0; cursor: pointer; font-size: 1rem; font-weight: bold; 
            background: #fff; color: #000; transition: 0.2s;
        }
        .btn-check-label:last-child { border-right: none; }
        
        .btn-check-pass:checked + label { background: #198754; color: white; }
        .btn-check-fail:checked + label { background: #dc3545; color: white; }

        /* 8. åœ–ç‰‡èˆ‡ç°½å */
        .illustration-container {
            text-align: center; margin-bottom: 15px; padding: 5px;
            border: 1px solid #000; background: #fff;
        }
        .illustration-img { max-width: 100%; max-height: 200px; object-fit: contain; }

        .sig-wrapper { 
            width: 100%; 
            height: 180px; 
            border: 2px solid #000; 
            border-radius: 0; 
            background: #fff; 
            position: relative;
            /* é˜²æ­¢å…§å®¹æº¢å‡º */
            overflow: hidden;
        }
        
        /* å¼·åˆ¶ Canvas å¡«æ»¿å®¹å™¨ï¼Œä¸¦ç¦æ­¢ç€è¦½å™¨é è¨­è§¸æ§è¡Œç‚º(å¦‚æ²å‹•) */
        #sig-canvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none; 
        }

        .sig-error { border-color: #dc3545; background: #fff5f5; }

        /* 9. æ‡¸æµ®æŒ‰éˆ• */
        .fab-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; align-items: flex-end; }
        .btn-float { 
            padding: 12px 20px; border-radius: 5px; 
            color: white; font-weight: bold; border: 2px solid #fff; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; min-width: 120px; font-size: 1rem;
        }
        .btn-main { background: #000; }
        .btn-warn { background: #cc0000; font-size: 0.9rem; min-width: 100px; }
        
        /* éšæ®µæ¨™ç±¤ */
        .stage-badge { 
            display: inline-block; padding: 4px 8px; border: 1px solid #000; 
            font-size: 0.8rem; margin-bottom: 5px; font-weight: bold; color: #fff; background: #333; 
        }

        .preview-img { max-width: 100%; height: 150px; border: 1px solid #000; display: none; margin-top: 5px; }

        #ios-install-prompt {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 2000; text-align: center; border-top: 4px solid #cc0000;
        }
    </style>
</head>
<body>

<div class="fab-container" id="fab-menu">
    <button type="button" class="btn-float btn-main" onclick="downloadReport()">ğŸ“¥ ä¸‹è¼‰å ±å‘Š</button>
    <button type="button" class="btn-float btn-warn" onclick="clearDraft()">ğŸ—‘ï¸ æ¸…é™¤é‡å¡«</button>
</div>

<div id="app-container">
    <form id="checkForm">
        <div class="app-header">
            <div class="app-title">ğŸ—ï¸ èµ·é‡åŠæ›ä½œæ¥­è¯åˆè‡ªæª¢</div>
            <div class="doc-subtitle">CRANE & RIGGING SAFETY CHECKLIST</div>
            <div style="margin-top:5px;">
                <small id="autoSaveStatus" style="color:#198754; display:none; font-weight:bold; border:1px solid #198754; padding:2px 5px;">âœ… è³‡æ–™å·²è‡ªå‹•å­˜æª”</small>
            </div>
        </div>

        <div class="section-title">1. ä½œæ¥­åŸºæœ¬è³‡æ–™ (BASIC INFO)</div>
        <div class="row">
            <div class="col-12"><label>æª¢æŸ¥æ—¥æœŸ Date</label><input type="date" id="checkDate"></div>
        </div>
        <div class="row">
            <div class="col-6"><label>1. ä¸»æ‰¿å•† Main Contractor</label><input type="text" id="mainContractor" oninput="autoSave()"></div>
            <div class="col-6"><label>2. æ¬¡æ‰¿å•† Sub Contractor</label><input type="text" id="subContractor" oninput="autoSave()"></div>
        </div>
        <div class="row">
            <div class="col-12">
                <label class="highlight-label">3. æª¢æŸ¥éšæ®µ Check Stage (è«‹é¸æ“‡) â˜…</label>
                <select id="checkStage" class="highlight-input" onchange="renderPanels(); autoSave();">
                    <option value="">-- è«‹é¸æ“‡æª¢æŸ¥éšæ®µ --</option>
                    <option value="pre">ä¸€ã€ ä½œæ¥­å‰æª¢æŸ¥ (Pre-Operation)</option>
                    <option value="during">äºŒã€ ä½œæ¥­ä¸­ç¢ºèª (During Operation)</option>
                    <option value="post">ä¸‰ã€ ä½œæ¥­å¾Œæª¢æŸ¥ (Post-Operation)</option>
                </select>
            </div>
            <div class="col-6"><label>4. æª¢æŸ¥äººå“¡å§“å Name</label><input type="text" id="inspectorName" oninput="autoSave()"></div>
            <div class="col-6"><label>5. åŠæ›é»ä½/è»Šè™Ÿ</label><input type="text" id="liftingPoint" placeholder="ä¾‹å¦‚: Aå€ / è»Šè™Ÿ123" oninput="autoSave()"></div>
        </div>

        <div id="panelList"></div>

        <div id="sig-section">
            <div class="section-title">3. ç°½åç¢ºèª (SIGNATURE)</div>
            <div class="sig-wrapper" id="sig-container">
                <canvas id="sig-canvas"></canvas>
            </div>
            <div style="margin-top:10px; text-align:right;">
                <button type="button" class="btn btn-sm btn-outline-dark" onclick="clearSignature()" style="border-radius:0;">â†º æ¸…é™¤é‡ç°½ (Clear)</button>
            </div>
        </div>
    </form>
</div>

<div id="ios-install-prompt">
    <p>ğŸ“² <strong>å®‰è£åˆ°æ‰‹æ©Ÿï¼š</strong><br>é»æ“Šä¸‹æ–¹åˆ†äº«æŒ‰éˆ•ï¼Œç„¶å¾Œé¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</p>
    <button class="btn btn-sm btn-outline-dark" onclick="document.getElementById('ios-install-prompt').style.display='none'">é—œé–‰</button>
</div>

<script>
    // === 1. æ›´æ–°å¾Œçš„è³‡æ–™è¨­å®š ===
    // stage: 'pre' (ä½œæ¥­å‰), 'during' (ä½œæ¥­ä¸­), 'post' (ä½œæ¥­å¾Œ)
    const CHECK_CONFIG = [
        // === ä¸€ã€ä½œæ¥­å‰æª¢æŸ¥ (Pre-Operation) ===
        {
            type: "group",
            id: "pre_doc",
            stage: "pre",
            title: "1. æ–‡ä»¶èˆ‡æ¬Šé™ç¢ºèª",
            items: [
                { id: "pre_01", title: "ã€æ“ä½œè³‡æ ¼èˆ‡ç‹€æ…‹ã€‘ç¢ºèªæ“ä½œå“¡è³‡æ ¼èˆ‡èº«å¿ƒç‹€æ³è‰¯å¥½ï¼Œä¸¦å·²é–±è®€ç›¸é—œå®‰å…¨æ‰‹å†Šæˆ–æŒ‡ä»¤ã€‚", image: "1-1.png" },
                { id: "pre_02", title: "ã€ç¾å ´å®‰å…¨ç¢ºèªã€‘ç¢ºèªåŠæ›ä½œæ¥­ä½œæ¥­æ¢ä»¶å®‰å…¨(å ´åœ°ã€æ°£æº«ã€å¤©æ°£ç­‰)ï¼Œä¸¦å‚³éçµ¦ç¾å ´ä½œæ¥­äººå“¡ã€‚", image: "1-2.png" }
            ]
        },
        {
            type: "group",
            id: "pre_visual",
            stage: "pre",
            title: "2. ç›®è¦–æª¢æŸ¥ (Visual Inspection)",
            items: [
                { id: "pre_03", title: "ã€èµ·é‡æ©Ÿæœ¬é«”ã€‘æª¢æŸ¥æ˜¯å¦æœ‰æ¼æ²¹ã€æ¼æ°£ (æ¶²å£“æˆ–æ°£å£“ç³»çµ±)ã€‚", image: "2-1.png" },
                { id: "pre_04", title: "ã€èµ·é‡æ©Ÿæœ¬é«”ã€‘æª¢æŸ¥é‹¼ç´¢æ˜¯å¦æ­£ç¢ºçºç¹åœ¨æ²ç­’èˆ‡æ»‘è¼ªå‡¹æ§½ä¸­ï¼Œç„¡äº‚ç¹©æˆ–è·³æ§½ç¾è±¡ã€‚", image: "2-2.png" },
                { id: "pre_05", title: "ã€åŠæ›å™¨å…·ã€‘æª¢æŸ¥åŠç´¢ (é‹¼ç´¢ã€éµéŠã€çº–ç¶­å¸¶) æ˜¯å¦æœ‰æ‰­çµã€æ–·çµ²ã€å‰²å‚·ã€è…è•æˆ–ç†±æå£ã€‚", image: "2-3.png" },
                { id: "pre_06", title: "ã€åŠæ›å™¨å…·ã€‘ç¢ºèªæ‰€æœ‰åŠå…·å‡æœ‰æ¸…æ™°çš„é¡å®šè·é‡æ¨™ç¤ºï¼Œç„¡æ¨™ç¤ºè€…ä¸å¾—ä½¿ç”¨ã€‚", image: "2-4.png" },
                { id: "pre_07", title: "ã€åŠæ›å™¨å…·ã€‘æª¢æŸ¥åŠé‰¤æ˜¯å¦æœ‰è®Šå½¢ã€è£‚ç´‹ï¼Œé˜²æ»‘èˆŒç‰‡æ˜¯å¦èƒ½æ­£å¸¸é–‰åˆã€‚", image: "2-5.png" }
            ]
        },
        {
            type: "group",
            id: "pre_func",
            stage: "pre",
            title: "3. åŠŸèƒ½æ¸¬è©¦ (Operational Tests) - é ˆåœ¨ç„¡è² è¼‰ä¸‹é€²è¡Œ",
            items: [
                { id: "pre_08", title: "ã€æ§åˆ¶å™¨æ–¹å‘ã€‘ç¢ºèªæ§åˆ¶æ¡¿æˆ–æŒ‰éˆ•çš„æ–¹å‘æ¨™ç¤º (ä¸Šã€ä¸‹ã€æ±ã€è¥¿ç­‰) èˆ‡å¯¦éš›å‹•ä½œæ–¹å‘ä¸€è‡´ã€‚", image: "3-1.png" },
                { id: "pre_09", title: "ã€ç…è»Šèˆ‡å‹•ä½œã€‘æ¸¬è©¦åŠå‡ã€æ©«è¡Œ(å°è»Š)ã€ç¸±è¡Œ(å¤§è»Š)çš„å‹•ä½œæ˜¯å¦é †æš¢ï¼Œä¸¦ç¢ºèªç…è»ŠåŠŸèƒ½æ­£å¸¸ã€‚", image: "3-2.png" },
                { id: "pre_10", title: "ã€éå·é é˜²è£ç½®ã€‘(é‡è¦â˜…) å¿…é ˆåœ¨ä½œæ¥­é–‹å§‹å‰æ¸¬è©¦ã€‚ä»¥æ…¢é€Ÿ(å¯¸å‹•)æ–¹å¼æå‡åŠé‰¤ï¼Œè§¸ç™¼é–‹é—œç¢ºèªæœƒè‡ªå‹•åœæ­¢ï¼Œé˜²æ­¢éå·ã€‚", image: "3-3.png" },
                { id: "pre_11", title: "ã€é€šè¨Šè­¦å‘Šè£ç½®ã€‘æ¸¬è©¦å°è¬›æ©Ÿã€æŒ‡æ®æ‰‹å‹¢æœ‰æ•ˆï¼Œè­¦éˆ´ã€å–‡å­æˆ–è­¦ç¤ºç‡ˆæ˜¯å¦é‹ä½œæ­£å¸¸ã€‚", image: "3-4.png" }
            ]
        },

        // === äºŒã€ä½œæ¥­ä¸­ç¢ºèª (Checks During Operation) ===
        {
            type: "group",
            id: "during_load",
            stage: "during",
            title: "1. åŠæ›èˆ‡è² è¼‰ç¢ºèª",
            items: [
                { id: "dur_01", title: "ã€é‡é‡ç¢ºèªã€‘ç¢ºèªè·ç‰©é‡é‡ä½æ–¼èµ·é‡æ©Ÿèˆ‡åŠå…·çš„é¡å®šè·é‡ (Rated Load)ï¼Œåš´ç¦è¶…è¼‰ã€‚", image: "2-1-1.png" },
                { id: "dur_02", title: "ã€é‡å¿ƒå¹³è¡¡ã€‘ç¢ºèªè·ç‰©å·²å›ºå®šç‰¢é ä¸”é‡å¿ƒå¹³è¡¡ï¼ŒåŠç´¢ç„¡æ‰­çµä¸”æœªç›´æ¥çºç¹è·ç‰© (æ‡‰ä½¿ç”¨é©ç•¶åŠå…·)ã€‚", image: "2-1-2.png" },
                { id: "dur_03", title: "ã€åŠæ›è§’åº¦ã€‘ç¢ºèªè·ç‰©å·²å›ºå®šç‰¢é ä¸”åŠæ›è§’åº¦ç‚º 30Â° < X < 60Â° å…§ã€‚", image: "2-1-3.png" },
                { id: "dur_04", title: "ã€é˜²æ­¢å‰²å‚·ã€‘è‹¥åŠç´¢æ¥è§¸è·ç‰©å°–éŠ³é‚Šè§’ï¼Œæ˜¯å¦å·²åŠ è£è­·è§’æˆ–è»Ÿå¢Šä¿è­·ã€‚", image: "2-1-4.png" }
            ]
        },
        {
            type: "group",
            id: "during_lift",
            stage: "during",
            title: "2. èµ·åŠæ“ä½œåŸå‰‡",
            items: [
                { id: "dur_05", title: "ã€å‚ç›´èµ·åŠã€‘ç¢ºèªé‹¼ç´¢å‚ç›´ä½æ–¼è·ç‰©æ­£ä¸Šæ–¹ï¼Œåš´ç¦å´æ‹‰ (Side Pull)ï¼Œä»¥å…æå£å°ç¹©å™¨æˆ–å°è‡´ç¿»è¦†ã€‚", image: "2-2-1.png" },
                { id: "dur_06", title: "ã€è©¦åŠã€‘(Inch/Trial Lift) æ˜¯å¦åŸ·è¡Œ 333 é‹å‹• (èµ·åŠ30å…¬åˆ†ã€æš«åœ3ç§’ã€ç¢ºèª3æ–¹å®‰å…¨)ã€‚", image: "2-2-2.png" },
                { id: "dur_07", title: "ã€å¹³ç©©æ“ä½œã€‘é¿å…æ€¥åŠ é€Ÿæˆ–æ€¥æ¸›é€Ÿ (Shock Loading)ã€‚", image: "2-2-3.png" }
            ]
        },
        {
            type: "group",
            id: "during_env",
            stage: "during",
            title: "3. ç’°å¢ƒèˆ‡äººå“¡ç®¡åˆ¶",
            items: [
                { id: "dur_05", title: "ã€ç‰½å¼•ç¹©ã€‘é•·åº¦æ˜¯å¦è¶³å¤ äººå“¡ç«™ç«‹æ–¼å®‰å…¨è·é›¢ä¹‹å¤–(éåŠæ›ç‰©æ­£ä¸‹æ–¹)é€²è¡Œæ§åˆ¶ï¼Œç‰½å¼•ç¹©æ‡‰è©²åœ¨åŠç‰©ä¸Šã€‚", image: "2-3-1.png" },
                { id: "dur_08", title: "ã€æ·¨ç©ºå€åŸŸã€‘ç¢ºèªåŠæ›è·¯å¾‘ä¸Šç„¡éšœç¤™ç‰©ï¼Œä¸”åš´ç¦åŠé‹è·ç‰©ç¶“éäººå“¡ä¸Šæ–¹ã€‚", image: "2-3-2.png" },
                { id: "dur_09", title: "ã€è½å¾æŒ‡æ®ã€‘æ“ä½œå“¡æ‡‰åªè½å¾æŒ‡å®šæŒ‡æ®äººå“¡ (Signal person) çš„ä¿¡è™Ÿï¼›(è¨»ï¼šè‹¥ä»»ä½•äººç™¼å‡ºã€Œåœæ­¢ã€ä¿¡è™Ÿï¼Œéƒ½å¿…é ˆç«‹å³åœæ­¢)ã€‚", image: "2-3-3.png" },
                { id: "dur_10", title: "ã€äººå“¡ç¦æ­¢ã€‘åš´ç¦ä»»ä½•äººæ­ä¹˜åŠé‰¤æˆ–ç«™åœ¨è·ç‰©ä¸Š (é™¤éä½¿ç”¨ç¬¦åˆè¦ç¯„ä¹‹è¼‰äººåŠç±ƒä¸¦ç¶“è¨±å¯)ã€‚", image: "2-3-4.png" }
            ]
        },

        // === ä¸‰ã€ä½œæ¥­å¾Œæª¢æŸ¥ (Post-Operation Checks) ===
        {
            type: "group",
            id: "post_park",
            stage: "post",
            title: "1. åœæ©Ÿä½ç½®èˆ‡è™•ç½®",
            items: [
                { id: "post_01", title: "ã€åŠé‰¤æ­¸ä½ã€‘å°‡åŠé‰¤èˆ‡åŠå…·å‡è‡³é›¢åœ°é©ç•¶é«˜åº¦ï¼Œé«˜æ–¼åœ°é¢æ‰€æœ‰éšœç¤™ç‰©ï¼Œä»¥å…äººå“¡æ’æ“Šã€‚", image: "3-1-1.png" },
                { id: "post_02", title: "ã€æ§åˆ¶å™¨æ­¸é›¶ã€‘å°‡æ‰€æœ‰æ§åˆ¶å™¨æ­¸å›ã€Œé—œé–‰ (OFF)ã€ä½ç½®ã€‚", image: "3-1-2.png" }
            ]
        },
        {
            type: "group",
            id: "post_power",
            stage: "post",
            title: "2. æ–·é›»èˆ‡å®‰å…¨é–å®š",
            items: [
                { id: "post_03", title: "ã€åˆ‡æ–·é›»æºã€‘æ‰“é–‹ (æ–·é–‹) ä¸»é›»æºé–‹é—œ (Main Disconnect Switch)ã€‚", image: "3-2-1.png" },
                { id: "post_04", title: "ã€æ”¶ç´æ§åˆ¶å™¨ã€‘è‹¥æ˜¯é™æ§æ“ä½œï¼Œæ‡‰é—œé–‰ç™¼å°„å™¨é›»æºä¸¦å­˜æ”¾åœ¨æŒ‡å®šå®‰å…¨è™•ã€‚", image: "3-2-2.png" }
            ]
        },
        {
            type: "group",
            id: "post_outdoor",
            stage: "post",
            title: "3. æˆ¶å¤–èµ·é‡æ©Ÿçš„é¡å¤–æªæ–½",
            items: [
                { id: "post_05", title: "ã€é˜²é¢¨å›ºå®šã€‘å°æ–¼æˆ¶å¤–å‹èµ·é‡æ©Ÿï¼Œæ˜¯å¦å·²æ¡å–é˜²é¢¨æªæ–½ (å¦‚å¤¾è»Œå™¨æˆ–éŒ¨å®šè£ç½®)ï¼Œä»¥é˜²æ­¢é¢¨åŠ›å¹å‹•èµ·é‡æ©Ÿæ»‘è¡Œã€‚", image: "3-3-1.png" }
            ]
        },
        {
            type: "group",
            id: "post_report",
            stage: "post",
            title: "4. ç•°å¸¸é€šå ±",
            items: [
                { id: "post_06", title: "ã€æ•…éšœå›å ±ã€‘è‹¥åœ¨ä½œæ¥­ä¸­ç™¼ç¾ä»»ä½•æ©Ÿæ¢°ç•°å¸¸ã€æ€ªè²æˆ–æå£ï¼Œå¿…é ˆé€šå ±ç®¡ç†äººå“¡æˆ–ä¸‹ä¸€ç­æ“ä½œå“¡ï¼Œä¸¦åœ¨ä¿®å¾©å‰ä¸å¾—å†ä½¿ç”¨ã€‚", image: "3-4-1.png" }
            ]
        }
    ];

    // === 2. Service Worker èˆ‡ iOS ===
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW failed', err)); });
    }
    const isIos = () => /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
    const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);
    if (isIos() && !isInStandaloneMode()) setTimeout(() => document.getElementById('ios-install-prompt').style.display = 'block', 2000);

    // === 3. IndexedDB è³‡æ–™åº« ===
    const DB_NAME = "UnifiedCheckDB_V2";
    const STORAGE_KEY = "CHECK_DRAFT_STAGE";
    let db;
    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = (e) => { db = e.target.result; if(!db.objectStoreNames.contains("drafts")) db.createObjectStore("drafts", { keyPath: "id" }); };
    request.onsuccess = (e) => { db = e.target.result; initPage(); };

    // === 4. ç°½åæ¿ (å·²ä¿®æ­£) ===
    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    
    // ä¿®æ­£å¾Œçš„ resizeCanvas å‡½å¼
    function resizeCanvas() {
        const wrapper = canvas.parentElement; 
        const rect = wrapper.getBoundingClientRect(); 
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        
        // è¨­å®š Canvas çš„ã€Œå¯¦éš›è§£æåº¦ã€
        canvas.width = rect.width * ratio; 
        canvas.height = rect.height * ratio;
        
        // ç¸®æ”¾ç¹ªåœ–ä¸Šä¸‹æ–‡ï¼Œè®“åº§æ¨™ç³»çµ±å°æ‡‰åˆ° CSS å°ºå¯¸
        ctx.scale(ratio, ratio); 
        ctx.lineWidth = 3; 
        ctx.lineCap = 'round'; 
        ctx.lineJoin = 'round'; 
        ctx.strokeStyle = '#000';
    }
    window.addEventListener('resize', resizeCanvas);
    
    function getPos(e) { 
        const rect = canvas.getBoundingClientRect(); 
        const cx = e.touches ? e.touches[0].clientX : e.clientX; 
        const cy = e.touches ? e.touches[0].clientY : e.clientY; 
        return { x: cx - rect.left, y: cy - rect.top }; 
    }
    function startDraw(e) { 
        if(e.target===canvas) e.preventDefault(); // é˜²æ­¢æ‰‹æ©Ÿæ»¾å‹•
        isDrawing=true; 
        const pos=getPos(e); 
        ctx.beginPath(); 
        ctx.moveTo(pos.x,pos.y); 
    }
    function draw(e) { 
        if(!isDrawing) return; 
        if(e.target===canvas) e.preventDefault(); // é˜²æ­¢æ‰‹æ©Ÿæ»¾å‹•
        const pos=getPos(e); 
        ctx.lineTo(pos.x,pos.y); 
        ctx.stroke(); 
    }
    function stopDraw() { if(isDrawing){ isDrawing=false; autoSave(); } }
    
    canvas.addEventListener('mousedown', startDraw); 
    canvas.addEventListener('mousemove', draw); 
    canvas.addEventListener('mouseup', stopDraw); 
    canvas.addEventListener('mouseout', stopDraw);
    
    // åŠ ä¸Š {passive: false} ç¢ºä¿ preventDefault æœ‰æ•ˆ
    canvas.addEventListener('touchstart', startDraw, {passive:false}); 
    canvas.addEventListener('touchmove', draw, {passive:false}); 
    canvas.addEventListener('touchend', stopDraw);
    
    function clearSignature() { ctx.clearRect(0,0,canvas.width,canvas.height); autoSave(); }
    function isCanvasBlank() { const blank=document.createElement('canvas'); blank.width=canvas.width; blank.height=canvas.height; return canvas.toDataURL()===blank.toDataURL(); }

    // === 5. é é¢åˆå§‹åŒ–èˆ‡æ¸²æŸ“ ===
    function initPage() {
        const now = new Date();
        document.getElementById('checkDate').value = now.toISOString().split('T')[0];
        loadDraftFromDB();
        setTimeout(resizeCanvas, 100);
    }

    // æ ¸å¿ƒæ¸²æŸ“å‡½æ•¸ï¼šæ ¹æ“šéšæ®µ (Stage) æ±ºå®šé¡¯ç¤ºå“ªäº›é¡Œç›®
    function renderPanels() {
        const container = document.getElementById('panelList'); 
        const selectedStage = document.getElementById('checkStage').value;
        
        if(!selectedStage) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:#666; border:2px dashed #ccc; margin-bottom:20px;">
                è«‹å…ˆæ–¼ä¸Šæ–¹<span style="color:#cc0000; font-weight:bold;">ã€Œ3. æª¢æŸ¥éšæ®µã€</span>é¸æ“‡é¡åˆ¥<br>
                (ä½œæ¥­å‰ / ä½œæ¥­ä¸­ / ä½œæ¥­å¾Œ)
                </div>`;
            return;
        }

        container.innerHTML = `<div class="section-title">2. æª¢æŸ¥é …ç›® CHECKLIST</div>`;
        
        const filteredConfig = CHECK_CONFIG.filter(config => config.stage === selectedStage);
        
        filteredConfig.forEach((config) => {
            let html = "";
            if (config.type === "group") {
                html += `
                <div class="group-box">
                    <div style="padding:10px 15px; background:#f0f0f0; border-bottom:1px solid #000;">
                          <span style="font-weight:bold; font-size:1.1rem;">${config.title}</span>
                    </div>
                    ${config.items.map(item => createQuestionHtml(item)).join('')}
                </div>`;
            }
            container.innerHTML += html;
        });
        
        restoreValuesAfterRender();
    }

    function createQuestionHtml(item) {
        let illustrationHtml = "";
        if(item.image) {
            illustrationHtml = `
            <div class="illustration-container">
                <span class="badge bg-secondary mb-1">åƒè€ƒç¤ºæ„åœ–</span>
                <img src="${item.image}" class="illustration-img" onerror="this.style.display='none'" alt="ç¤ºæ„åœ–">
            </div>`;
        }
        
        return `<div class="panel-row" id="row_${item.id}" data-id="${item.id}">
            <div class="item-title">${item.title}</div>
            ${illustrationHtml}
            <div class="btn-check-group">
                <input type="radio" class="btn-check-pass" name="${item.id}" id="${item.id}_pass" value="Pass" onchange="checkStatus('${item.id}'); autoSave()">
                <label class="btn-check-label" for="${item.id}_pass">æ˜¯ (Yes)</label>
                <input type="radio" class="btn-check-fail" name="${item.id}" id="${item.id}_fail" value="Fail" onchange="checkStatus('${item.id}'); autoSave()">
                <label class="btn-check-label" for="${item.id}_fail">å¦ (No)</label>
            </div>
            <div style="margin-top:10px;">
                <input type="text" id="note_${item.id}" placeholder="å‚™è¨»èªªæ˜ (Remarks)..." oninput="autoSave()" style="margin-bottom:5px; border-bottom:1px solid #ccc; border-top:none; border-left:none; border-right:none;">
                <label class="btn btn-sm btn-outline-secondary w-100" style="border-radius:0;">
                    ğŸ“· æ‹æ”ç…§ç‰‡ / ä¸Šå‚³ Photo
                    <input type="file" id="file_${item.id}" accept="image/*" capture="environment" style="display:none" onchange="handleImage(this, '${item.id}')">
                </label>
                <div class="preview-container"><img id="preview_${item.id}" class="preview-img"></div>
            </div>
        </div>`;
    }

    window.checkStatus = function(id) {
        const row = document.getElementById(`row_${id}`);
        if(row) {
            const pass = document.getElementById(`${id}_pass`).checked;
            const fail = document.getElementById(`${id}_fail`).checked;
            row.classList.remove('completed', 'error');
            if(pass) row.classList.add('completed');
            if(fail) row.classList.add('error');
        }
    }

    window.handleImage = function(input, id) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById(`preview_${id}`);
                img.src = e.target.result; img.style.display = 'inline-block';
                autoSave();
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // === 6. è‡ªå‹•å„²å­˜èˆ‡è®€å– ===
    let savedDataCache = null; 
    let saveTimer; 
    window.autoSave = function() { clearTimeout(saveTimer); saveTimer = setTimeout(saveToDB, 500); }
    
    function saveToDB() {
        if(!db) return;
        const basicInfo = {
            date: document.getElementById('checkDate').value,
            main: document.getElementById('mainContractor').value,
            sub: document.getElementById('subContractor').value,
            stage: document.getElementById('checkStage').value,
            insp: document.getElementById('inspectorName').value,
            point: document.getElementById('liftingPoint').value
        };
        
        const radios = Array.from(document.querySelectorAll('input[type="radio"]:checked')).map(r => r.id);
        const notes = Array.from(document.querySelectorAll('input[type="text"][id^="note_"]')).reduce((acc, el) => ({...acc, [el.id]: el.value}), {});
        const images = Array.from(document.querySelectorAll('.preview-img')).reduce((acc, img) => (img.src && img.src.startsWith('data:') ? {...acc, [img.id]: img.src} : acc), {});
        
        savedDataCache = { radios, notes, images };

        const data = { id: STORAGE_KEY, basicInfo: basicInfo, radios: radios, notes: notes, images: images, signature: isCanvasBlank() ? null : canvas.toDataURL() };
        const tx = db.transaction(["drafts"], "readwrite"); tx.objectStore("drafts").put(data);
        tx.oncomplete = () => { const status = document.getElementById('autoSaveStatus'); status.style.display='inline'; setTimeout(()=> status.style.display='none', 2000); };
    }

    function loadDraftFromDB() {
        if(!db) return;
        db.transaction(["drafts"]).objectStore("drafts").get(STORAGE_KEY).onsuccess = (e) => {
            const data = e.target.result; if(!data) return;
            
            if(data.basicInfo) {
                document.getElementById('checkDate').value = data.basicInfo.date || "";
                document.getElementById('mainContractor').value = data.basicInfo.main || "";
                document.getElementById('subContractor').value = data.basicInfo.sub || "";
                document.getElementById('inspectorName').value = data.basicInfo.insp || "";
                document.getElementById('liftingPoint').value = data.basicInfo.point || "";
                document.getElementById('checkStage').value = data.basicInfo.stage || "";
            }

            savedDataCache = { radios: data.radios || [], notes: data.notes || {}, images: data.images || {} };
            renderPanels(); 

            restoreValuesAfterRender();

            if(data.signature) { const i = new Image(); i.src = data.signature; i.onload = () => ctx.drawImage(i,0,0, canvas.width, canvas.height); }
        };
    }

    function restoreValuesAfterRender() {
        if(!savedDataCache) return;
        if(savedDataCache.radios) {
            savedDataCache.radios.forEach(id => { 
                const el = document.getElementById(id); 
                if(el) { el.checked = true; const rowId = id.replace(/_(pass|fail)$/, ''); checkStatus(rowId); } 
            });
        }
        if(savedDataCache.notes) {
            Object.keys(savedDataCache.notes).forEach(k => { 
                const el = document.getElementById(k); 
                if(el) el.value = savedDataCache.notes[k]; 
            });
        }
        if(savedDataCache.images) {
            Object.keys(savedDataCache.images).forEach(k => { 
                const img = document.getElementById(k); 
                if(img) { img.src = savedDataCache.images[k]; img.style.display = 'inline-block'; } 
            });
        }
    }

    window.clearDraft = function() { if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™é‡å¡«å—ï¼Ÿ")) { db.transaction(["drafts"], "readwrite").objectStore("drafts").delete(STORAGE_KEY); location.reload(); } }

    // === 7. ä¸‹è¼‰å ±å‘Š ===
    window.downloadReport = function() {
        const basicFields = ['mainContractor', 'checkStage', 'inspectorName', 'liftingPoint', 'checkDate'];
        if(basicFields.some(id => !document.getElementById(id).value)) { alert("âš ï¸ è«‹å¡«å¯«å®Œæ•´çš„ã€Œä½œæ¥­åŸºæœ¬è³‡æ–™ã€ï¼"); window.scrollTo(0,0); return; }
        if(isCanvasBlank()) { alert("âš ï¸ è«‹ç°½åï¼"); document.getElementById('sig-canvas').classList.add('sig-error'); document.getElementById('sig-section').scrollIntoView(); return; }
        
        const visibleRows = Array.from(document.querySelectorAll('.panel-row')).filter(row => row.offsetParent !== null);
        
        let errorCount = 0; let firstErrorRow = null;
        visibleRows.forEach(row => {
            const id = row.getAttribute('data-id');
            const pass = document.getElementById(`${id}_pass`).checked;
            const fail = document.getElementById(`${id}_fail`).checked;
            if(!pass && !fail) { errorCount++; row.classList.add('error'); if(!firstErrorRow) firstErrorRow = row; }
        });
        if(errorCount > 0) { alert(`âŒ å°šæœ‰ ${errorCount} å€‹æª¢æŸ¥é …ç›®æœªå‹¾é¸ï¼`); firstErrorRow.scrollIntoView({behavior:'smooth', block:'center'}); return; }

        let reportItemsHtml = ""; let failCount = 0;
        visibleRows.forEach(row => {
            const id = row.getAttribute('data-id');
            const title = row.querySelector('.item-title').innerText;
            
            const isPass = document.getElementById(`${id}_pass`).checked;
            const noteVal = document.getElementById(`note_${id}`).value;
            const imgEl = document.getElementById(`preview_${id}`);
            if(!isPass) failCount++;
            
            const statusHtml = isPass ? '<span class="txt-pass">âœ” åˆæ ¼</span>' : '<span class="txt-fail">âœ˜ ç•°å¸¸</span>';
            const noteHtml = noteVal ? `<div style="margin-top:2px; font-size:14px; color:#555;">å‚™è¨»ï¼š${noteVal}</div>` : "";
            const imgHtml = (imgEl && imgEl.src && imgEl.style.display !== 'none') ? `<img src="${imgEl.src}" class="report-img-large">` : "";

            reportItemsHtml += `
            <div class="report-item" style="${!isPass ? 'background-color:#fff5f5;' : ''}">
                <div class="report-item-head"><span>${title}</span> ${statusHtml}</div>
                ${noteHtml} ${imgHtml}
            </div>`;
        });

        const main = document.getElementById('mainContractor').value;
        const sub = document.getElementById('subContractor').value;
        const insp = document.getElementById('inspectorName').value;
        const stageSelect = document.getElementById('checkStage');
        const stageText = stageSelect.options[stageSelect.selectedIndex].text;
        
        const point = document.getElementById('liftingPoint').value;
        const checkDate = document.getElementById('checkDate').value;
        
        const fullHtml = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><title>èµ·é‡åŠæ›æª¢æŸ¥å ±å‘Š</title>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; padding: 40px; background: #fff; color: #000; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; border: 2px solid #000; padding: 30px; }
        .report-header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; }
        .report-title { font-size: 28px; font-weight: 900; margin: 0; color: #000; }
        .report-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; border: 1px solid #000; padding: 20px; background: #fff; font-size: 16px; }
        .report-section-title { font-size: 18px; font-weight: bold; color: #fff; background: #000; padding: 5px 10px; margin-bottom: 15px; margin-top: 25px; -webkit-print-color-adjust: exact; }
        .report-item { border-bottom: 1px solid #000; padding: 12px 0; }
        .report-item-head { font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .report-img-large { max-height: 300px; max-width: 100%; border: 1px solid #000; display: block; margin: 8px 0; }
        .report-footer { margin-top: 40px; display: flex; justify-content: space-between; }
        .report-sig-box { text-align: center; width: 45%; border: 1px solid #000; padding: 10px; }
        .report-sig-line { border-top: 1px solid #000; padding-top: 8px; font-weight: bold; margin-top: 5px; font-size: 16px;}
        .report-sig-img { height: 70px; display: block; margin: 0 auto; }
        .txt-pass { color: #000; font-weight:bold; } .txt-fail { color: #cc0000; font-weight:bold; }
    </style></head><body>
    <div class="container">
        <div class="report-header"><div class="report-title">ğŸ—ï¸ èµ·é‡åŠæ›æª¢æŸ¥å ±å‘Š</div></div>
        <div class="report-info-grid">
            <div><strong>æ—¥æœŸï¼š</strong> ${checkDate}</div>
            <div><strong>æª¢æŸ¥éšæ®µï¼š</strong> ${stageText}</div>
            <div><strong>ä¸»æ‰¿å•†ï¼š</strong> ${main}</div>
            <div><strong>æ¬¡æ‰¿å•†ï¼š</strong> ${sub}</div>
            <div><strong>åŠæ›é»ä½ï¼š</strong> ${point}</div>
            <div><strong>æª¢æŸ¥äººå“¡ï¼š</strong> ${insp}</div>
        </div>
        <div class="report-section-title">æª¢æŸ¥é …ç›®ç´°ç¯€</div>
        <div>${reportItemsHtml}</div>
        <div style="margin-top:20px; font-size:18px; font-weight:bold; border-top:2px solid #000; padding-top:10px;">
            ç¸½çµï¼š${failCount > 0 ? '<span style="color:red">ç•°å¸¸ (' + failCount + ' é …) - è«‹ç«‹å³æ”¹å–„</span>' : '<span style="color:green">å…¨æ•¸åˆæ ¼ - å¯é–‹å§‹ä½œæ¥­</span>'}
        </div>
        <div class="report-footer">
            <div class="report-sig-box"><img src="${canvas.toDataURL()}" class="report-sig-img"><div class="report-sig-line">æª¢æŸ¥äººå“¡ç°½ç« </div></div>
            <div class="report-sig-box"><div style="height:70px;"></div><div class="report-sig-line">å·¥åœ°ä¸»ä»»/ç›£å·¥è¤‡æ ¸</div></div>
        </div>
    </div></body></html>`;

        const blob = new Blob([fullHtml], {type: "text/html;charset=utf-8"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `æª¢æŸ¥å ±å‘Š_${checkDate}_${stageSelect.value}.html`;
        link.click();
    }
</script>
</body>
</html>